<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>owlsh ‚Äî Sight Words Terminal</title>
  <meta name="theme-color" content="#0d1117">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            t: {
              bg: '#0d1117',
              surface: '#161b22',
              fg: '#e6edf3',
              dim: '#484f58',
              border: '#30363d',
              accent: '#f4845f',
              blue: '#58a6ff',
              green: '#3fb950',
              red: '#f85149',
              yellow: '#d29922',
              purple: '#bc8cff',
            }
          },
          fontFamily: {
            mono: ['"JetBrains Mono"', '"SF Mono"', '"Cascadia Code"', '"Fira Code"', 'Consolas', 'monospace'],
          }
        }
      },
      safelist: [
        'text-t-accent','text-t-blue','text-t-green','text-t-red',
        'text-t-yellow','text-t-purple','text-t-dim','text-t-fg',
        'font-bold','animate-pulse','underline','opacity-50',
        'bg-t-green/20','bg-t-red/20',
      ]
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
    body { font-family: 'JetBrains Mono', monospace; }
    .scanlines {
      background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
      z-index: 10;
    }
    @keyframes blink { 50% { opacity: 0; } }
    .cursor-blink { animation: blink 1s step-end infinite; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }
    .shake { animation: shake 0.3s ease-out; }
    @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .pop-in { animation: popIn 0.25s ease-out; }
    pre { tab-size: 2; }
    #input:focus { outline: none; }
    ::selection { background: rgba(244,132,95,0.3); }
    .logo-wrap { display: block; transform-origin: center top; }
    #back-btn { display: none; cursor: pointer; -webkit-tap-highlight-color: transparent; }
    #back-btn.visible { display: inline-block; }
  </style>
</head>
<body class="bg-t-bg min-h-screen flex items-center justify-center p-3 sm:p-8 selection:bg-t-accent/30">
  <div class="w-full max-w-[68ch]">
    <!-- Terminal title bar -->
    <div class="flex items-center gap-2 px-4 py-2 bg-t-surface rounded-t-lg border border-t-border">
      <div class="flex gap-1.5">
        <div class="w-2.5 h-2.5 rounded-full bg-t-red/80"></div>
        <div class="w-2.5 h-2.5 rounded-full bg-t-yellow/80"></div>
        <div class="w-2.5 h-2.5 rounded-full bg-t-green/80"></div>
      </div>
      <span id="back-btn" class="text-t-dim text-xs px-1" onclick="goBack()">‚óÄ back</span>
      <span id="title-bar" class="text-t-dim text-xs flex-1 text-center">owlsh v1.0</span>
      <span id="mute-btn" class="text-sm px-1 cursor-pointer leading-none" onclick="toggleMute()" style="-webkit-tap-highlight-color:transparent" title="Toggle sound">üîä</span>
    </div>

    <!-- Terminal body -->
    <div class="border border-t-0 border-t-border rounded-b-lg bg-t-bg relative overflow-hidden">
      <div class="absolute inset-0 pointer-events-none scanlines"></div>
      <pre id="screen" class="px-4 sm:px-6 pt-4 pb-2 text-t-fg text-[16px] sm:text-[18px] leading-[1.6] min-h-[55vh] sm:min-h-[60vh] whitespace-pre-wrap fade-in"></pre>
      <div id="input-bar" class="flex items-center px-4 sm:px-6 py-3 border-t border-t-border">
        <span class="text-t-accent font-bold mr-2 text-base sm:text-lg">‚ùØ</span>
        <input
          id="input"
          type="text"
          class="bg-transparent text-t-fg text-base sm:text-lg outline-none flex-1 caret-t-accent placeholder:text-t-dim/40 font-mono"
          autofocus
          autocomplete="off"
          autocapitalize="off"
          spellcheck="false"
          placeholder="Type here..."
        />
      </div>
    </div>
    <div class="text-center mt-2 text-t-dim text-[10px]">built with care</div>
  </div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  owlsh ‚Äî Sight Words Terminal Game
//  All game modes ‚Ä¢ Adaptive difficulty ‚Ä¢ Profile tracking
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ‚îÄ WORD DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LEVELS = [
  { key: 'hatchling', name: 'Hatchling',  icon: 'ü•í', desc: 'Just starting out' },
  { key: 'fledgling', name: 'Fledgling',  icon: 'üê£', desc: 'Learning the basics' },
  { key: 'flyer',     name: 'Flyer',      icon: 'üê•', desc: 'Taking flight' },
  { key: 'soarer',    name: 'Soarer',     icon: 'ü¶Ö', desc: 'Riding the winds' },
  { key: 'owl',       name: 'Owl Master', icon: 'ü¶â', desc: 'Wise and masterful' },
];

const WORDS = {
  hatchling: ['a','and','away','big','blue','can','come','down','find','for','funny','go','help','here','I','in','is','it','jump','little','look','make','me','my','not','one','play','red','run','said','see','the','three','to','two','up','we','where','yellow','you'],
  fledgling: ['all','am','are','at','ate','be','black','brown','but','came','did','do','eat','four','get','good','have','he','into','like','must','new','no','now','on','our','out','please','pretty','ran','ride','saw','say','she','so','soon','that','there','they','this','too','under','want','was','well','went','what','white','who','will','with','yes'],
  flyer: ['after','again','an','any','as','ask','by','could','every','fly','from','give','going','had','has','her','him','his','how','just','know','let','live','may','of','old','once','open','over','put','round','some','stop','take','thank','them','then','think','walk','were','when'],
  soarer: ['always','around','because','been','before','best','both','buy','call','cold','does','don\'t','fast','first','five','found','gave','goes','green','its','made','many','off','or','pull','read','right','sing','sit','sleep','tell','their','these','those','upon','us','use','very','wash','which','why','wish','work','would','write','your'],
  owl: ['about','better','bring','carry','clean','cut','done','draw','drink','eight','fall','far','full','got','grow','hold','hot','hurt','if','keep','kind','laugh','light','long','much','myself','never','only','own','pick','seven','shall','show','six','small','start','ten','today','together','try','warm'],
};

const SENTENCES = {
  // Hatchling
  a:['I see ___ cat.','She ate ___ big apple.','I want ___ new toy.'],
  and:['Mom ___ Dad are here.','Cats ___ dogs are pets.','I ran ___ I jumped.'],
  away:['Go ___!','Run ___!','Put it ___.'],
  big:['That is a ___ house.','I see a ___ dog.','What a ___ tree!'],
  blue:['The sky is ___.','I have a ___ hat.','The ___ bird sings.'],
  can:['I ___ jump high.','She ___ run fast.','You ___ do it!'],
  come:['___ here please!','___ play with me!','___ see this!'],
  down:['Sit ___.','Go ___ the hill.','Put it ___.'],
  find:['Can you ___ it?','Help me ___ my toy.','I will ___ the way.'],
  for:['This is ___ you.','I made it ___ Mom.','A gift ___ my friend.'],
  funny:['That is so ___!','The ___ dog ran.','What a ___ joke!'],
  go:['Let us ___!','Time to ___ home.','I want to ___ now.'],
  help:['Can you ___ me?','I need ___ please.','I like to ___ others.'],
  here:['Come over ___.','Put it ___.','I am right ___.'],
  I:['___ am happy today.','___ like to play.','___ can see you.'],
  in:['The cat is ___ the box.','Put it ___ the bag.','I am ___ the house.'],
  is:['She ___ my friend.','It ___ a nice day.','That ___ so cool!'],
  it:['I like ___.','Give ___ to me.','I see ___ now.'],
  jump:['I can ___ high.','___ over it!','The frog can ___.'],
  little:['The ___ bird sings.','I have a ___ cat.','A ___ bug sat here.'],
  look:['___ at that!','___ over here!','Come ___ at this!'],
  make:['Let us ___ a cake.','I will ___ a fort.','Can you ___ it?'],
  me:['Give it to ___.','Play with ___.','Come see ___.'],
  my:['This is ___ book.','I love ___ dog.','Where is ___ hat?'],
  not:['I am ___ sad.','It is ___ here.','She did ___ go.'],
  one:['I have ___ apple.','Just ___ more!','Pick ___ please.'],
  play:['Let us ___!','I want to ___ now.','Come ___ with me.'],
  red:['I see a ___ ball.','The ___ hat is mine.','I like ___ roses.'],
  run:['I can ___ fast.','Let us ___!','The dog will ___.'],
  said:['She ___ hello.','Mom ___ it is time.','He ___ yes!'],
  see:['I can ___ you.','Come ___ the birds.','Do you ___ it?'],
  the:['___ dog is big.','I like ___ sun.','___ cat is soft.'],
  three:['I have ___ cats.','I see ___ birds.','Count to ___.'],
  to:['I want ___ go.','Give it ___ me.','Time ___ eat!'],
  two:['I have ___ hands.','I see ___ ducks.','She has ___ eyes.'],
  up:['Look ___!','Jump ___!','Get ___ now.'],
  we:['___ are friends.','___ like to play.','___ can do it!'],
  where:['___ is the cat?','___ did it go?','___ are you?'],
  yellow:['The ___ sun shines.','I see a ___ bus.','A ___ duck swims.'],
  you:['I like ___.','___ are so nice.','Can ___ see it?'],
  // Fledgling
  all:['We ___ went home.','I ate ___ of it.','They ___ came to play.'],
  am:['I ___ right here.','I ___ so happy.','I ___ ready to go.'],
  are:['You ___ so smart.','They ___ at school.','We ___ best friends.'],
  at:['Look ___ the bird.','I am ___ home.','She is ___ the park.'],
  ate:['I ___ my lunch.','She ___ the cake.','We ___ all the fruit.'],
  be:['I want to ___ kind.','You can ___ brave.','It will ___ fun.'],
  black:['The ___ cat sat.','I see a ___ bird.','She has ___ shoes.'],
  brown:['A ___ bear sleeps.','The ___ dog ran.','I see a ___ leaf.'],
  but:['I like it ___ not now.','I fell ___ I am fine.','She tried ___ missed.'],
  came:['She ___ to play.','He ___ home late.','They ___ to see us.'],
  did:['What ___ you do?','She ___ a good job.','How ___ it go?'],
  do:['What ___ you see?','I can ___ it!','___ you like cats?'],
  eat:['I want to ___.','Time to ___ lunch.','Let us ___ now.'],
  four:['I have ___ toys.','I see ___ birds.','She is ___ years old.'],
  get:['I need to ___ my bag.','Come ___ your hat.','Can I ___ a snack?'],
  good:['That was ___!','You did a ___ job.','It is a ___ day.'],
  have:['I ___ a dog.','You ___ big eyes.','We ___ so much fun.'],
  he:['___ is my friend.','___ likes to run.','___ can jump high.'],
  into:['Jump ___ the pool.','Run ___ the house.','We went ___ the fort.'],
  like:['I ___ to read.','I ___ pizza.','Do you ___ cats?'],
  must:['You ___ be kind.','I ___ go home.','We ___ try hard.'],
  new:['I got a ___ toy.','She has a ___ hat.','Look at my ___ book!'],
  no:['___ thank you.','I have ___ more.','___ way!'],
  now:['Let us go ___.','Do it ___!','I am ready ___.'],
  on:['The book is ___ the table.','Put it ___ top.','I sat ___ the chair.'],
  our:['This is ___ house.','I like ___ class.','___ dog is the best.'],
  out:['Let us go ___.','Come ___ and play.','The sun came ___.'],
  please:['Can I have some ___?','Help me ___.','Come here ___.'],
  pretty:['What a ___ flower!','The ___ bird sings.','She looks so ___.'],
  ran:['The dog ___ fast.','She ___ to school.','I ___ all the way.'],
  ride:['I want to ___ my bike.','Can I ___ with you?','Let us ___ the bus.'],
  saw:['I ___ a bird.','She ___ the rainbow.','We ___ a big fish.'],
  say:['What did you ___?','I ___ thank you.','Can you ___ it again?'],
  she:['___ is my sister.','___ likes to sing.','___ ran very fast.'],
  so:['I am ___ happy!','It was ___ much fun.','She is ___ kind.'],
  soon:['We will go ___.','It will be done ___.','Come back ___.'],
  that:['I like ___ one.','Look at ___!','What is ___?'],
  there:['Look over ___!','I was right ___.','Go over ___ now.'],
  they:['___ are playing.','___ like ice cream.','___ went to the park.'],
  this:['I want ___ one.','Look at ___!','___ is the best.'],
  too:['I want to come ___!','Me ___!','It is ___ hot.'],
  under:['The cat is ___ the bed.','Look ___ the table.','It hid ___ a leaf.'],
  want:['I ___ to play.','I ___ a snack.','Do you ___ to come?'],
  was:['It ___ so fun.','She ___ here first.','The day ___ sunny.'],
  well:['I feel ___.','She sings ___.','All is ___ now.'],
  went:['We ___ to the park.','He ___ home early.','They ___ to the zoo.'],
  what:['___ is that?','___ a fun day!','___ do you see?'],
  white:['A ___ rabbit hops.','The ___ snow falls.','I see a ___ cloud.'],
  who:['___ is that?','___ wants to play?','___ can help me?'],
  will:['I ___ help you.','She ___ come soon.','It ___ be fun.'],
  with:['Come ___ me.','Play ___ us.','I went ___ Dad.'],
  yes:['___ I can!','___ please!','She said ___!'],
  // Flyer
  after:['We play ___ lunch.','Come ___ me.','I nap ___ school.'],
  again:['Do it ___!','Let us play ___.','Say it ___ please.'],
  an:['I ate ___ apple.','I saw ___ owl.','She has ___ idea.'],
  any:['Do you have ___ pets?','Is there ___ left?','I like ___ color.'],
  as:['Fast ___ the wind!','Big ___ a bear.','Soft ___ a cloud.'],
  ask:['I want to ___ you.','May I ___ a question?','Just ___ for help.'],
  by:['Sit ___ me.','Walk ___ the lake.','A book ___ my bed.'],
  could:['I ___ hear the music.','She ___ run all day.','___ you help me?'],
  every:['I read ___ day.','___ kid played.','She smiles ___ time.'],
  fly:['Birds can ___.','I wish I could ___.','Watch it ___ away.'],
  from:['A letter ___ Grandma.','I came ___ school.','A gift ___ a friend.'],
  give:['I will ___ you one.','Please ___ me a turn.','___ it a try.'],
  going:['I am ___ home.','We are ___ to the park.','She is ___ to sing.'],
  had:['I ___ a fun day.','She ___ a big smile.','We ___ so much fun.'],
  has:['She ___ a red hat.','He ___ two dogs.','The cake ___ sprinkles.'],
  her:['That is ___ book.','I gave ___ a hug.','___ mom is nice.'],
  him:['I gave it to ___.','Call ___ over here.','Tell ___ the news.'],
  his:['That is ___ dog.','I like ___ shoes.','___ smile is big.'],
  how:['___ are you today?','___ did you do that?','___ many do you see?'],
  just:['I ___ got here.','It is ___ right.','She ___ smiled.'],
  know:['I ___ the answer!','Do you ___?','I ___ you can do it.'],
  let:['___ me try it.','___ us go now.','___ her play too.'],
  live:['I ___ in a house.','Fish ___ in water.','We ___ near a park.'],
  may:['You ___ go now.','___ I have one?','It ___ rain today.'],
  of:['A cup ___ water.','A box ___ toys.','A pair ___ socks.'],
  old:['The ___ tree is tall.','My ___ toy broke.','She is six years ___.'],
  once:['I went there ___.','___ upon a time.','Try it just ___.'],
  open:['Please ___ the door.','___ your eyes.','The box is ___.'],
  over:['Jump ___ the rock.','Come ___ here.','It is ___ now.'],
  put:['___ it down gently.','___ on your coat.','I ___ it away.'],
  round:['The ball is ___.','We went ___ and ___.','A ___ moon shines.'],
  some:['I want ___ water.','Here are ___ toys.','May I have ___?'],
  stop:['Please ___ running.','___ and look.','We need to ___.'],
  take:['___ my hand.','___ a big step.','Please ___ one.'],
  thank:['___ you so much!','I ___ my teacher.','___ you for the gift.'],
  them:['I gave it to ___.','Tell ___ to come.','I like ___ a lot.'],
  then:['First eat ___ play.','We sang ___ danced.','I woke up ___ smiled.'],
  think:['I ___ it is fun.','I ___ you are right.','Let me ___ about it.'],
  walk:['Let us ___ to school.','I like to ___ the dog.','We ___ every morning.'],
  were:['They ___ very happy.','We ___ at the zoo.','The kids ___ so loud.'],
  when:['___ is your birthday?','I smile ___ I play.','___ can we go?'],
  // Soarer
  always:['I ___ brush my teeth.','She ___ shares her toys.','We ___ say please.'],
  around:['We ran ___ the park.','Look ___ you.','Turn ___ in a circle.'],
  because:['I smiled ___ I was happy.','We stayed in ___ it rained.','I like her ___ she is kind.'],
  been:['I have ___ there before.','She has ___ so kind.','Have you ___ to the zoo?'],
  before:['Wash hands ___ you eat.','I read ___ bed.','Think ___ you act.'],
  best:['You are the ___!','That was the ___ day.','She is my ___ friend.'],
  both:['We ___ like dogs.','___ of us laughed.','I want ___ please.'],
  buy:['I want to ___ a book.','Can we ___ some fruit?','Mom will ___ it.'],
  call:['I will ___ my friend.','___ me when you can.','Did you ___ her?'],
  cold:['The water is ___.','It is ___ outside.','My hands are ___.'],
  does:['She ___ her homework.','What ___ it mean?','He ___ his best.'],
  'don\'t':['I ___ want to go.','___ forget your bag.','They ___ like bugs.'],
  fast:['The rabbit runs ___.','She swims ___.','How ___ can you go?'],
  first:['I was ___ in line.','___ we eat then play.','She came in ___.'],
  five:['I have ___ fingers.','Count to ___.','There are ___ ducks.'],
  found:['I ___ my toy!','She ___ a shell.','We ___ a nice spot.'],
  gave:['She ___ me a hug.','He ___ us a ride.','I ___ my friend a gift.'],
  goes:['He ___ to school.','She ___ to the park.','The bell ___ ring!'],
  green:['The frog is ___.','I see ___ leaves.','She has a ___ hat.'],
  its:['The dog wagged ___ tail.','The bird sang ___ song.','The cat licked ___ paw.'],
  made:['I ___ a drawing.','She ___ her bed.','We ___ a snowman.'],
  many:['How ___ do you have?','So ___ stars shine.','I have ___ friends.'],
  off:['Turn ___ the light.','Take ___ your hat.','Jump ___ the log.'],
  or:['Milk ___ water?','Yes ___ no?','Big ___ small?'],
  pull:['___ the door open.','Help me ___ it.','___ up your socks.'],
  read:['I love to ___ books.','___ it out loud.','She can ___ fast.'],
  right:['You got it ___!','Turn ___ here.','That is the ___ way.'],
  sing:['I like to ___ songs.','Can you ___?','Birds ___ at dawn.'],
  sit:['Please ___ down.','___ by me.','The dog can ___.'],
  sleep:['I need to ___.','Time to go to ___.','The baby will ___ soon.'],
  tell:['Please ___ me a story.','___ me what you see.','Can you ___ her?'],
  their:['That is ___ house.','I like ___ dog.','___ yard is big.'],
  these:['I like ___ shoes.','___ are so pretty.','Look at ___ fish.'],
  those:['Look at ___ birds.','I want ___ ones.','___ are my toys.'],
  upon:['Once ___ a time.','A star shone ___ us.','Sit ___ the chair.'],
  us:['Come play with ___.','Tell ___ a joke.','She helped ___.'],
  use:['I can ___ a pencil.','May I ___ that?','___ your words.'],
  very:['I am ___ happy.','She is ___ tall.','It was ___ cold.'],
  wash:['Please ___ your hands.','I will ___ the cup.','___ the dog today.'],
  which:['___ one do you want?','___ way do we go?','___ color is best?'],
  why:['___ is the sky blue?','Tell me ___.','___ did you go?'],
  wish:['I ___ for a puppy.','Make a ___!','I ___ it was summer.'],
  work:['Let us ___ together.','I like to ___ hard.','Good ___!'],
  would:['I ___ like some cake.','She ___ love this.','___ you help me?'],
  write:['I can ___ my name.','Let me ___ it down.','She will ___ a note.'],
  your:['Is this ___ book?','I like ___ smile.','Tie ___ shoes.'],
  // Owl
  about:['Tell me ___ your day.','What is it ___?','I read ___ animals.'],
  better:['I feel ___ now.','She did even ___.','This one is ___.'],
  bring:['Please ___ your book.','I will ___ the food.','___ it to me.'],
  carry:['I can ___ the bag.','Help me ___ this.','She will ___ her doll.'],
  clean:['My room is ___.','We need to ___ up.','The dish is ___.'],
  cut:['I will ___ the paper.','She ___ the ribbon.','Do not ___ that.'],
  done:['Are you ___ yet?','I am all ___.','When will it be ___?'],
  draw:['I like to ___.','___ a picture.','She can ___ a cat.'],
  drink:['I need a ___ of water.','May I have a ___?','Take a ___ please.'],
  eight:['I am ___ years old.','Count to ___.','There are ___ bees.'],
  fall:['Leaves ___ in autumn.','Do not ___ down.','I love ___ colors.'],
  far:['The park is not ___.','How ___ is it?','It is ___ away.'],
  full:['The cup is ___.','I am ___ now.','The moon is ___.'],
  got:['I ___ a new toy!','She ___ a gold star.','We ___ to go.'],
  grow:['Plants ___ in the sun.','I will ___ big.','Watch the seeds ___.'],
  hold:['Please ___ my hand.','Can you ___ this?','___ on tight!'],
  hot:['The soup is ___.','It is ___ today.','The sand is ___.'],
  hurt:['I hope it does not ___.','My knee ___s.','Did that ___?'],
  if:['We can go ___ it is sunny.','___ you try you can do it.','What ___ it rains?'],
  keep:['I will ___ it safe.','___ going!','You can ___ that.'],
  kind:['She is very ___.','Be ___ to others.','What a ___ thing to do.'],
  laugh:['That joke made me ___.','I love to ___.','We all ___ed.'],
  light:['Turn on the ___.','The bag is ___.','The sun gives us ___.'],
  long:['It has been a ___ day.','How ___ is the line?','We took a ___ walk.'],
  much:['Thank you so ___!','How ___ is it?','I like you so ___.'],
  myself:['I did it all by ___!','I made it ___.','I can tie my shoes by ___.'],
  never:['I have ___ seen snow.','___ give up!','She ___ stops smiling.'],
  only:['I have ___ one left.','She is the ___ one.','It takes ___ a minute.'],
  own:['I have my ___ room.','She has her ___ bike.','I made my ___ lunch.'],
  pick:['Please ___ a color.','___ up your toys.','I will ___ this one.'],
  seven:['There are ___ days.','I am ___ years old.','She ate ___ grapes.'],
  shall:['We ___ go together.','___ we dance?','What ___ we do?'],
  show:['Let me ___ you.','___ and tell is fun.','Can you ___ me how?'],
  six:['I have ___ crayons.','She is ___ years old.','I see ___ ducks.'],
  small:['The mouse is ___.','A ___ seed grows big.','I have a ___ cat.'],
  start:['Let us ___ the game!','Ready to ___?','___ from the top.'],
  ten:['I can count to ___.','We need ___ more.','There are ___ in all.'],
  today:['I am happy ___.','___ is a good day.','What did you do ___?'],
  together:['We play ___.','Let us sing ___.','We are ___ again.'],
  try:['I will ___ my best.','___ it one more time.','Let me ___ that.'],
  warm:['The sun feels ___.','Put on a ___ coat.','The blanket is ___.'],
};

// ‚îÄ‚îÄ‚îÄ ASCII ART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Block-character owl ‚Äî renders cleanly in all monospace fonts
const OWL = {
  idle: `    ‚ñÑ‚ñà‚ñà‚ñà‚ñÑ
   ‚ñà ‚óâ ‚óâ ‚ñà
    ‚ñà ‚ñæ ‚ñà
    ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ
     ‚ñà ‚ñà
    ‚ñÄ   ‚ñÄ`,
  happy: `    ‚ñÑ‚ñà‚ñà‚ñà‚ñÑ
   ‚ñà ‚óï‚Äø‚óï ‚ñà
    ‚ñà   ‚ñà
    ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ
     ‚ñà ‚ñà
    ‚ñÄ   ‚ñÄ`,
  celebrate: `  ‚ú¶ ‚ñÑ‚ñà‚ñà‚ñà‚ñÑ ‚ú¶
   ‚ñà ‚óï‚ó°‚óï ‚ñà
    ‚ñà   ‚ñà
    ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ
    ‚ñà   ‚ñà
   ‚ñÄ     ‚ñÄ`,
  think: `    ‚ñÑ‚ñà‚ñà‚ñà‚ñÑ  ¬∑
   ‚ñà ‚óâ ‚óâ ‚ñà¬∑
    ‚ñà - ‚ñà
    ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ
     ‚ñà ‚ñà
    ‚ñÄ   ‚ñÄ`,
  encourage: `    ‚ñÑ‚ñà‚ñà‚ñà‚ñÑ
   ‚ñà ‚óâ ‚óâ ‚ñà
    ‚ñà ‚ó° ‚ñà
    ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ
     ‚ñà ‚ñà
    ‚ñÄ   ‚ñÄ`,
};

// Big block title for welcome screen (from oh-my-logo)
const LOGO = ` ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë
‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
 ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù`;

const AVATARS = [
  { id: 'owl',    face: '{‚óâ,‚óâ}', name: 'Owl' },
  { id: 'cat',    face: '(^.^)',  name: 'Cat' },
  { id: 'bear',   face: ' ï‚Ä¢·¥•‚Ä¢ î', name: 'Bear' },
  { id: 'bunny',  face: '(‚óï.‚óï)', name: 'Bunny' },
  { id: 'fox',    face: '(‚Ä¢·¥ó‚Ä¢)', name: 'Fox' },
];

const CHEERS = ['Amazing!','Fantastic!','Brilliant!','Superb!','Nailed it!','Perfect!','Outstanding!','Wonderful!','Great job!','You rock!'];
const NUDGES = ['Almost!','Try again!','So close!','You got this!','Keep going!','One more try!','Almost there!','Don\'t give up!'];

const MODES = [
  { key: 'flash',    name: 'Flash',    icon: '‚ú¶', desc: 'See it, remember it, type it' },
  { key: 'fill',     name: 'Fill',     icon: '‚óß', desc: 'Complete the missing letters' },
  { key: 'scramble', name: 'Scramble', icon: '‚óà', desc: 'Unscramble the jumbled letters' },
  { key: 'rush',     name: 'Rush',     icon: '‚ñ∂', desc: 'Type fast ‚Äî beat the clock!' },
  { key: 'story',    name: 'Story',    icon: '‚ñ§', desc: 'Fill the blank in a sentence' },
];

// ‚îÄ‚îÄ‚îÄ AUDIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let actx;
function initAudio() {
  if (!actx) actx = new AudioCtx();
  if (actx.state === 'suspended') actx.resume();
}
let muted = localStorage.getItem('owlsh_muted') === '1';
function toggleMute() {
  muted = !muted;
  localStorage.setItem('owlsh_muted', muted ? '1' : '0');
  render();
}
function tone(freq, dur, type = 'sine', vol = 0.12) {
  if (!actx || muted) return;
  const o = actx.createOscillator(), g = actx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = vol;
  g.gain.exponentialRampToValueAtTime(0.001, actx.currentTime + dur);
  o.connect(g); g.connect(actx.destination);
  o.start(); o.stop(actx.currentTime + dur);
}
function sndCorrect() { tone(523,0.1); setTimeout(()=>tone(659,0.1),70); setTimeout(()=>tone(784,0.15),140); }
function sndWrong()   { tone(220,0.25,'triangle',0.08); }
function sndLevelUp() { [523,587,659,698,784].forEach((f,i)=>setTimeout(()=>tone(f,0.12),i*90)); }
function sndTick()    { tone(1000,0.02,'square',0.03); }
function sndRush()    { tone(440,0.08,'sawtooth',0.06); }

// ‚îÄ‚îÄ‚îÄ STORE (localStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STORE_KEY = 'owlsh_data';

function loadStore() {
  try { return JSON.parse(localStorage.getItem(STORE_KEY)) || { profiles: [], activeProfile: null }; }
  catch { return { profiles: [], activeProfile: null }; }
}

function saveStore(data) {
  localStorage.setItem(STORE_KEY, JSON.stringify(data));
}

function getActiveProfile() {
  const store = loadStore();
  if (store.activeProfile === null) return null;
  return store.profiles[store.activeProfile] || null;
}

function saveActiveProfile(profile) {
  const store = loadStore();
  if (store.activeProfile !== null) {
    store.profiles[store.activeProfile] = profile;
    saveStore(store);
  }
}

function createProfile(name, avatarId) {
  const store = loadStore();
  const profile = {
    name,
    avatar: avatarId,
    level: null, // null = needs discovery
    mastery: {},  // { word: { seen, correct, streak, stars } }
    stats: { totalScore: 0, wordsLearned: 0, sessionsPlayed: 0, bestStreak: 0 },
    created: Date.now(),
  };
  store.profiles.push(profile);
  store.activeProfile = store.profiles.length - 1;
  saveStore(store);
  return profile;
}

function setActiveProfileIndex(idx) {
  const store = loadStore();
  store.activeProfile = idx;
  saveStore(store);
}

function getWordMastery(profile, word) {
  return profile.mastery[word] || { seen: 0, correct: 0, streak: 0, stars: 0 };
}

function updateMastery(profile, word, wasCorrect) {
  const m = getWordMastery(profile, word);
  m.seen++;
  if (wasCorrect) {
    m.correct++;
    m.streak++;
    if (m.streak >= 3 && m.stars < 5) m.stars = Math.min(5, m.stars + 1);
  } else {
    m.streak = 0;
    if (m.stars > 0) m.stars = Math.max(0, m.stars - 1);
  }
  profile.mastery[word] = m;
  saveActiveProfile(profile);
}

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let S = {
  screen: 'welcome',
  // profile creation
  newName: '',
  newAvatar: 0,
  // game
  level: 0,
  mode: 0,
  words: [],
  wordIdx: 0,
  score: 0,
  streak: 0,
  bestStreak: 0,
  correct: 0,
  results: [],
  phase: 'show', // flash mode: 'show' | 'type'
  attempts: 0,
  hint: '',
  timer: null,
  // rush mode
  rushTime: 60,
  rushTimer: null,
  rushActive: false,
  // discovery
  discoveryWords: [],
  discoveryResults: [],
  discoveryIdx: 0,
  discoveryPhase: 'show',
  // feedback
  lastCorrect: false,
  lastWord: '',
  // misc
  inputEnabled: true,
  deleteConfirm: false,
};

// ‚îÄ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $ = id => document.getElementById(id);
let W = 58; // content width in characters (updated dynamically)

function updateW() {
  const scr = $('screen');
  if (!scr || !scr.clientWidth) return;
  const style = getComputedStyle(scr);
  const contentPx = scr.clientWidth - parseFloat(style.paddingLeft) - parseFloat(style.paddingRight);
  const ruler = document.createElement('span');
  ruler.style.cssText = 'position:absolute;visibility:hidden;white-space:pre';
  ruler.textContent = '0000000000';
  scr.appendChild(ruler);
  const chPx = ruler.getBoundingClientRect().width / 10;
  scr.removeChild(ruler);
  if (chPx > 0) W = Math.floor(contentPx / chPx);
}

function tc(text, color) { return `<span class="text-t-${color}">${text}</span>`; }
function tb(text) { return `<span class="font-bold">${text}</span>`; }
function tdim(text) { return tc(text, 'dim'); }

function center(text) {
  const stripped = text.replace(/<[^>]*>/g, '');
  const pad = Math.max(0, Math.floor((W - stripped.length) / 2));
  return ' '.repeat(pad) + text;
}

function centerBlock(text) {
  const lines = text.split('\n');
  const maxLen = Math.max(...lines.map(l => l.replace(/<[^>]*>/g, '').length));
  const pad = Math.max(0, Math.floor((W - maxLen) / 2));
  return lines.map(l => ' '.repeat(pad) + l).join('\n');
}

function hr(ch = '‚îÄ') { return tdim(ch.repeat(W)); }

function progressBar(cur, total, w = 20) {
  const filled = Math.round((cur / Math.max(total, 1)) * w);
  return tc('‚ñà'.repeat(filled), 'green') + tdim('‚ñë'.repeat(w - filled));
}

function stars(n, max = 5) {
  return tc('‚òÖ'.repeat(n), 'yellow') + tdim('‚òÜ'.repeat(max - n));
}

function opt(key, label) {
  return `  ${tc('[' + key + ']', 'yellow')}  ${label}`;
}

function owlArt(mood = 'idle') { return OWL[mood] || OWL.idle; }

function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// ‚îÄ‚îÄ‚îÄ WORD SELECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pickWords(levelKey, count = 10) {
  const profile = getActiveProfile();
  const pool = [...WORDS[levelKey]];
  // Sort by mastery (ascending) so weaker words appear first
  pool.sort((a, b) => {
    const mA = getWordMastery(profile, a).stars;
    const mB = getWordMastery(profile, b).stars;
    if (mA !== mB) return mA - mB;
    return Math.random() - 0.5;
  });
  return shuffle(pool.slice(0, Math.min(count, pool.length)));
}

function makeMissing(word) {
  const chars = word.split('');
  const hide = Math.max(1, Math.ceil(chars.length * 0.4));
  const idxs = shuffle(chars.map((_, i) => i)).slice(0, hide);
  const set = new Set(idxs);
  return chars.map((c, i) => set.has(i) ? '_' : c).join('');
}

function makeScramble(word) {
  if (word.length <= 2) return word.split('').reverse().join('');
  let s; let tries = 0;
  do { s = shuffle(word.split('')).join(''); tries++; } while (s === word && tries < 30);
  return s;
}

// ‚îÄ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function screenWelcome() {
  const logo = centerBlock(LOGO.split('\n').map(l => tc(l, 'accent')).join('\n'));
  return [
    '',
    `<span class="logo-wrap">${logo}</span>`,
    center(tdim('sight words terminal')),
    '',
    centerBlock(owlArt('idle')),
    '',
    center(tc('Learn sight words, one keystroke at a time.', 'dim')),
    '',
    center(tc('Press ENTER to begin', 'accent') + ' ' + tc('‚ñà', 'accent cursor-blink')),
    '',
  ].join('\n');
}

function screenProfiles() {
  const store = loadStore();
  const profiles = store.profiles;
  let lines = ['', tb('  Who is playing?'), ''];

  if (profiles.length === 0) {
    lines.push('  No profiles yet. Let\'s create one!');
    lines.push('');
    lines.push(opt('1', 'Create new profile'));
  } else {
    profiles.forEach((p, i) => {
      const av = AVATARS.find(a => a.id === p.avatar) || AVATARS[0];
      const lvl = p.level !== null ? LEVELS[p.level].name : 'New';
      lines.push(opt(i + 1, `${av.face}  ${p.name}  ${tdim('(' + lvl + ')')}`));
    });
    lines.push('');
    if (profiles.length < 5) {
      lines.push(opt('+', 'Create new profile'));
    }
  }
  lines.push('');
  return lines.join('\n');
}

function screenNewProfile() {
  let lines = ['', tb('  Create Your Profile'), '', hr()];

  if (!S.newName) {
    lines.push('');
    lines.push('  What should I call you?');
    lines.push('');
    lines.push(tdim('  Type your name and press ENTER'));
    lines.push('');
  } else {
    lines.push('');
    lines.push(`  Name: ${tc(S.newName, 'accent')}`);
    lines.push('');
    lines.push('  Pick your avatar:');
    lines.push('');
    AVATARS.forEach((a, i) => {
      const sel = i === S.newAvatar ? tc(' ‚óÄ', 'accent') : '';
      lines.push(opt(i + 1, `${a.face}  ${a.name}${sel}`));
    });
    lines.push('');
    lines.push(hr());
    lines.push('');
    lines.push(opt('go', `Create profile as ${tc(S.newName, 'accent')}`));
    lines.push('');
  }
  return lines.join('\n');
}

function screenMenu() {
  const profile = getActiveProfile();
  if (!profile) return screenProfiles();
  const av = AVATARS.find(a => a.id === profile.avatar) || AVATARS[0];
  const lvlInfo = profile.level !== null ? LEVELS[profile.level] : null;
  const allWords = Object.values(WORDS).flat();
  const mastered = allWords.filter(w => (profile.mastery[w]||{}).stars >= 5).length;

  let lines = [
    '',
    `  ${av.face}  ${tc('Welcome back, ' + profile.name + '!', 'accent')}`,
    '',
  ];

  if (lvlInfo) {
    lines.push(`  Level: ${tc(lvlInfo.icon + ' ' + lvlInfo.name, 'blue')}  ${tdim('|')}  Mastered: ${tc(mastered + '/' + allWords.length, 'green')}`);
    lines.push(`  ${progressBar(mastered, allWords.length, 30)}`);
  } else {
    lines.push(`  ${tc('New player ‚Äî take the Skill Discovery to find your level!', 'yellow')}`);
  }

  lines.push('');
  lines.push(hr());
  lines.push('');
  lines.push(opt('1', `${tc('‚ñ∂', 'green')} Play`));
  lines.push(opt('2', `${tc('‚óá', 'blue')} Skill Discovery`));
  lines.push(opt('3', `${tc('‚ñ¶', 'purple')} Progress`));
  lines.push(opt('4', `${tc('?', 'yellow')} How to Play`));
  lines.push('');
  lines.push(hr());
  lines.push('');
  lines.push(`  ${tdim('[p] Switch profile')}  ${tdim('[x] Delete profile')}`);
  lines.push('');
  return lines.join('\n');
}

function screenLevelSelect() {
  const profile = getActiveProfile();
  let lines = ['', tb('  Choose Your Level'), ''];

  LEVELS.forEach((lvl, i) => {
    const words = WORDS[lvl.key];
    const mastered = words.filter(w => (profile.mastery[w]||{}).stars >= 5).length;
    const pct = Math.round((mastered / words.length) * 100);
    const current = profile.level === i ? tc(' ‚óÄ current', 'accent') : '';
    lines.push(opt(i + 1, `${lvl.icon} ${lvl.name.padEnd(12)} ${progressBar(mastered, words.length, 12)} ${tc(pct + '%', pct === 100 ? 'green' : 'dim')}${current}`));
  });

  lines.push('');
  lines.push(hr());
  lines.push(opt('0', tdim('Back')));
  lines.push('');
  return lines.join('\n');
}

function screenModeSelect() {
  const lvl = LEVELS[S.level];
  let lines = [
    '',
    `  Level: ${tc(lvl.icon + ' ' + lvl.name, 'blue')}`,
    '',
    tb('  Choose Game Mode'),
    '',
  ];

  MODES.forEach((m, i) => {
    lines.push(opt(i + 1, `${tc(m.icon, 'accent')} ${m.name}`));
    lines.push(`       ${tdim(m.desc)}`);
    lines.push('');
  });

  lines.push(hr());
  lines.push(opt('0', tdim('Back')));
  lines.push('');
  return lines.join('\n');
}

function screenGame() {
  const word = S.words[S.wordIdx];
  const mode = MODES[S.mode];
  const lvl = LEVELS[S.level];

  // Progress dots
  const dots = S.words.map((_, i) => {
    if (i < S.wordIdx) return S.results[i]?.correct ? tc('‚óè', 'green') : tc('‚óè', 'red');
    if (i === S.wordIdx) return tc('‚óâ', 'accent');
    return tdim('‚óã');
  }).join(' ');

  let lines = [
    `  ${tc(lvl.name, 'blue')} ${tdim('‚îÇ')} ${tc(mode.icon + ' ' + mode.name, 'accent')} ${tdim('‚îÇ')} Score: ${tc(S.score, 'yellow')}`,
    '',
    `  ${dots}`,
    `  Streak: ${S.streak > 0 ? tc(S.streak + ' fire', 'accent') : tdim('0')}`,
    '',
    hr(),
  ];

  if (S.mode === 0) { // Flash
    if (S.phase === 'show') {
      lines.push('');
      lines.push(center(tdim('Look at this word:')));
      lines.push('');
      lines.push(center(tc(tb(word.toUpperCase()), 'fg')));
      lines.push('');
      lines.push(center(tdim('Remember it...')));
      lines.push('');
    } else {
      lines.push('');
      lines.push(center(tc('What was the word?', 'blue')));
      lines.push('');
      if (S.attempts > 0) {
        lines.push(center(tc(rand(NUDGES), 'yellow')));
        if (S.attempts >= 1) {
          const hint = word[0] + '_'.repeat(Math.max(0, word.length - 2)) + (word.length > 1 ? word[word.length-1] : '');
          lines.push(center(tdim('Hint: ' + hint.split('').join(' '))));
        }
        lines.push('');
      }
    }
  } else if (S.mode === 1) { // Fill
    lines.push('');
    lines.push(center(tdim('Complete the word:')));
    lines.push('');
    lines.push(center(tc(tb(S.hint.split('').join(' ')), 'fg')));
    lines.push('');
    if (S.attempts > 0) {
      lines.push(center(tc(rand(NUDGES), 'yellow')));
      lines.push('');
    }
  } else if (S.mode === 2) { // Scramble
    lines.push('');
    lines.push(center(tdim('Unscramble the letters:')));
    lines.push('');
    lines.push(center(tc(tb(S.hint.split('').join(' ')), 'purple')));
    lines.push(center(tdim(`(${word.length} letters)`)));
    lines.push('');
    if (S.attempts > 0) {
      lines.push(center(tc(rand(NUDGES), 'yellow')));
      lines.push('');
    }
  } else if (S.mode === 3) { // Rush
    const bar = progressBar(S.rushTime, 60, 30);
    lines = [
      `  ${tc('‚ñ∂ RUSH', 'accent')} ${tdim('‚îÇ')} ${bar} ${tc(S.rushTime + 's', S.rushTime <= 10 ? 'red' : 'blue')}`,
      '',
      `  Score: ${tc(S.score, 'yellow')}  Streak: ${S.streak > 0 ? tc(S.streak, 'accent') : tdim('0')}`,
      '',
      hr(),
      '',
    ];
    if (S.rushActive) {
      lines.push(center(tc(tb(word.toUpperCase()), 'fg')));
      lines.push('');
      if (S.attempts > 0) {
        lines.push(center(tc('Nope! Try again.', 'red')));
        lines.push('');
      }
    } else {
      lines.push(center(tc('Time is up!', 'yellow')));
      lines.push('');
      lines.push(center(`You typed ${tc(S.correct, 'green')} words correctly!`));
      lines.push(center(`Score: ${tc(S.score, 'yellow')}  Best streak: ${tc(S.bestStreak, 'accent')}`));
      lines.push('');
      lines.push(hr());
      lines.push('');
      lines.push(opt('1', 'Play again'));
      lines.push(opt('2', 'Change mode'));
      lines.push(opt('0', 'Menu'));
      lines.push('');
    }
  } else if (S.mode === 4) { // Story
    const pool = SENTENCES[word];
    const sentence = pool ? pool[Math.floor(Math.random() * pool.length)] : `The word is ___.`;
    const display = sentence.replace('___', tc(tb('___'), 'accent'));
    lines.push('');
    lines.push(center(tdim('Fill in the blank:')));
    lines.push('');
    lines.push(`    "${display}"`);
    lines.push('');
    if (S.attempts > 0) {
      lines.push(center(tc(rand(NUDGES), 'yellow')));
      lines.push('');
    }
  }

  return lines.join('\n');
}

function screenFeedback() {
  let lines = [];
  if (S.lastCorrect) {
    lines.push('');
    lines.push(centerBlock(owlArt('happy')));
    lines.push('');
    lines.push(center(tc('‚úì ' + rand(CHEERS), 'green')));
    lines.push('');
    lines.push(center(tc(tb(S.lastWord.toUpperCase()), 'fg')));
    if (S.streak > 1) {
      lines.push('');
      lines.push(center(tc(S.streak + ' in a row!', 'accent')));
    }
  } else {
    lines.push('');
    lines.push(centerBlock(owlArt('encourage')));
    lines.push('');
    lines.push(center(tdim('The word was:')));
    lines.push('');
    lines.push(center(tc(tb(S.lastWord.toUpperCase()), 'fg')));
    lines.push('');
    lines.push(center(tc('You\'ll get it next time!', 'yellow')));
  }
  lines.push('');
  return lines.join('\n');
}

function screenResults() {
  const profile = getActiveProfile();
  const pct = Math.round((S.correct / Math.max(S.words.length, 1)) * 100);
  const mood = pct >= 80 ? 'celebrate' : pct >= 50 ? 'happy' : 'encourage';

  let lines = [
    '',
    centerBlock(owlArt(mood)),
    '',
    center(tc(tb('Round Complete!'), 'accent')),
    '',
    `  Score: ${tc(S.score, 'yellow')}    Correct: ${tc(S.correct + '/' + S.words.length, pct >= 80 ? 'green' : 'blue')}    Streak: ${tc(S.bestStreak, 'accent')}`,
    '',
    hr(),
    '',
  ];

  S.results.forEach(r => {
    const icon = r.correct ? tc('‚úì', 'green') : tc('‚úó', 'red');
    const m = getWordMastery(profile, r.word);
    lines.push(`  ${icon}  ${r.word.padEnd(12)} ${stars(m.stars)}`);
  });

  lines.push('');
  lines.push(hr());
  lines.push('');
  lines.push(opt('1', 'Play again'));
  lines.push(opt('2', 'Change mode'));
  lines.push(opt('3', 'Change level'));
  lines.push(opt('0', 'Menu'));
  lines.push('');
  return lines.join('\n');
}

function screenProgress() {
  const profile = getActiveProfile();
  const av = AVATARS.find(a => a.id === profile.avatar) || AVATARS[0];
  let lines = [
    '',
    `  ${av.face}  ${tc(profile.name + '\'s Progress', 'accent')}`,
    '',
    hr(),
    '',
  ];

  let totalMastered = 0;
  let totalWords = 0;

  LEVELS.forEach((lvl, i) => {
    const words = WORDS[lvl.key];
    totalWords += words.length;
    const mastered = words.filter(w => (profile.mastery[w]||{}).stars >= 5).length;
    totalMastered += mastered;
    const practiced = words.filter(w => (profile.mastery[w]||{}).seen > 0).length;
    const pct = Math.round((mastered / words.length) * 100);
    const current = profile.level === i ? tc(' ‚óÄ', 'accent') : '';

    lines.push(`  ${tc(lvl.icon + ' ' + lvl.name, 'blue')}${current}  ${tdim('(' + words.length + ' words)')}`);
    lines.push(`  ${progressBar(mastered, words.length, 25)} ${tc(pct + '%', pct === 100 ? 'green' : 'dim')}`);
    lines.push(`  ${tc(mastered + ' mastered', 'green')} ${tdim('|')} ${tc(practiced + ' practiced', 'dim')}`);
    lines.push('');
  });

  lines.push(hr());
  lines.push('');
  lines.push(`  Total: ${tc(totalMastered + '/' + totalWords + ' words mastered', 'green')}`);
  lines.push(`  Sessions: ${tc(profile.stats.sessionsPlayed, 'blue')}  Total Score: ${tc(profile.stats.totalScore, 'yellow')}  Best Streak: ${tc(profile.stats.bestStreak, 'accent')}`);
  lines.push('');
  lines.push(hr());
  lines.push(opt('0', tdim('Back')));
  lines.push('');
  return lines.join('\n');
}

function screenHowToPlay() {
  let lines = [
    '',
    tb('  How to Play'),
    '',
    hr(),
    '',
    `  ${tc('‚ú¶ Flash', 'accent')}`,
    `  A word flashes on screen. After it`,
    `  disappears, type it from memory!`,
    '',
    `  ${tc('‚óß Fill', 'accent')}`,
    `  Some letters are replaced with ${tc('_', 'fg')}.`,
    `  Type the complete word.`,
    '',
    `  ${tc('‚óà Scramble', 'accent')}`,
    `  Letters are jumbled up. Figure out`,
    `  the word and type it correctly.`,
    '',
    `  ${tc('‚ñ∂ Rush', 'accent')}`,
    `  60 seconds on the clock! Type as`,
    `  many words as you can, as fast as`,
    `  you can. Build streaks for bonuses!`,
    '',
    `  ${tc('‚ñ§ Story', 'accent')}`,
    `  Read a sentence with a blank.`,
    `  Type the missing word.`,
    '',
    hr(),
    '',
    `  ${tc('Scoring:', 'yellow')}`,
    `  First try: ${tc('+10', 'green')}  Second try: ${tc('+5', 'blue')}`,
    `  Streak bonus: ${tc('+1 per word', 'accent')} in streak`,
    '',
    `  ${tc('Mastery:', 'yellow')}`,
    `  Get a word right 3 times in a row`,
    `  across sessions to earn ${tc('‚òÖ', 'yellow')} stars.`,
    `  5 stars = fully mastered!`,
    '',
    hr(),
    opt('0', tdim('Back')),
    '',
  ];
  return lines.join('\n');
}

function screenDiscovery() {
  const total = S.discoveryWords.length;
  const idx = S.discoveryIdx;

  if (idx >= total) {
    // Show results
    const scores = [0,0,0,0,0]; // per level
    S.discoveryResults.forEach(r => { if (r.correct) scores[r.level]++; });
    // Find highest level where they got 2+ correct
    let bestLevel = 0;
    for (let i = 4; i >= 0; i--) {
      if (scores[i] >= 2) { bestLevel = i; break; }
    }

    const profile = getActiveProfile();
    profile.level = bestLevel;
    saveActiveProfile(profile);

    let lines = [
      '',
      centerBlock(owlArt('celebrate')),
      '',
      center(tc(tb('Discovery Complete!'), 'accent')),
      '',
    ];
    LEVELS.forEach((lvl, i) => {
      const s = scores[i];
      const bar = tc('‚óè'.repeat(s), 'green') + tdim('‚óã'.repeat(3 - s));
      const chosen = i === bestLevel ? tc(' ‚óÄ Your level!', 'accent') : '';
      lines.push(`  ${lvl.icon} ${lvl.name.padEnd(12)} ${bar}${chosen}`);
    });
    lines.push('');
    lines.push(center(`You are a ${tc(tb(LEVELS[bestLevel].icon + ' ' + LEVELS[bestLevel].name), 'blue')}!`));
    lines.push('');
    lines.push(center(tdim('Press ENTER to continue')));
    lines.push('');
    return lines.join('\n');
  }

  const entry = S.discoveryWords[idx];
  const word = entry.word;
  const dots = S.discoveryWords.map((_, i) => {
    if (i < idx) return S.discoveryResults[i]?.correct ? tc('‚óè', 'green') : tc('‚óè', 'red');
    if (i === idx) return tc('‚óâ', 'accent');
    return tdim('‚óã');
  }).join(' ');

  let lines = [
    '',
    `  ${tc('‚óá Skill Discovery', 'blue')} ${tdim('‚îÇ')} ${idx + 1}/${total}`,
    '',
    `  ${dots}`,
    '',
    hr(),
    '',
  ];

  if (S.discoveryPhase === 'show') {
    lines.push(center(tdim('Look at this word:')));
    lines.push('');
    lines.push(center(tc(tb(word.toUpperCase()), 'fg')));
    lines.push('');
    lines.push(center(tdim('Remember it...')));
  } else {
    lines.push(center(tc('Type the word you saw:', 'blue')));
    lines.push('');
  }
  lines.push('');
  return lines.join('\n');
}

function screenDeleteConfirm() {
  const profile = getActiveProfile();
  return [
    '',
    center(tc(tb('Delete Profile?'), 'red')),
    '',
    center(`Are you sure you want to delete`),
    center(`${tc(profile.name, 'accent')}'s profile?`),
    center(tdim('This cannot be undone.')),
    '',
    opt('yes', tc('Delete it', 'red')),
    opt('no', 'Keep it'),
    '',
  ].join('\n');
}

// ‚îÄ‚îÄ‚îÄ GAME ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function startRound() {
  const levelKey = LEVELS[S.level].key;
  S.words = pickWords(levelKey, S.mode === 3 ? 40 : 10);
  S.wordIdx = 0;
  S.score = 0;
  S.streak = 0;
  S.bestStreak = 0;
  S.correct = 0;
  S.results = [];
  S.attempts = 0;
  S.screen = 'game';

  const profile = getActiveProfile();
  profile.stats.sessionsPlayed++;
  saveActiveProfile(profile);

  if (S.mode === 3) { // Rush
    S.rushTime = 60;
    S.rushActive = true;
    prepareWord();
    startRushTimer();
  } else {
    prepareWord();
  }
}

function prepareWord() {
  const word = S.words[S.wordIdx];
  S.attempts = 0;

  if (S.mode === 0) { // Flash
    S.phase = 'show';
    S.inputEnabled = false;
    render();
    const dur = Math.max(3000, Math.min(6000, word.length * 600));
    S.timer = setTimeout(() => {
      S.phase = 'type';
      S.inputEnabled = true;
      render();
      $('input').focus();
    }, dur);
  } else if (S.mode === 1) { // Fill
    S.hint = makeMissing(word);
    S.phase = 'type';
    S.inputEnabled = true;
    render();
  } else if (S.mode === 2) { // Scramble
    S.hint = makeScramble(word);
    S.phase = 'type';
    S.inputEnabled = true;
    render();
  } else if (S.mode === 3) { // Rush
    S.phase = 'type';
    S.inputEnabled = true;
    render();
  } else if (S.mode === 4) { // Story
    S.phase = 'type';
    S.inputEnabled = true;
    render();
  }
}

function startRushTimer() {
  if (S.rushTimer) clearInterval(S.rushTimer);
  S.rushTimer = setInterval(() => {
    S.rushTime--;
    if (S.rushTime <= 10) sndTick();
    if (S.rushTime <= 0) {
      clearInterval(S.rushTimer);
      S.rushTimer = null;
      S.rushActive = false;
      S.inputEnabled = false;
      sndLevelUp();
      // Save stats
      const profile = getActiveProfile();
      profile.stats.totalScore += S.score;
      if (S.bestStreak > profile.stats.bestStreak) profile.stats.bestStreak = S.bestStreak;
      saveActiveProfile(profile);
    }
    render();
  }, 1000);
}

function checkAnswer(answer) {
  const word = S.words[S.wordIdx];
  const correct = answer.toLowerCase().trim() === word.toLowerCase();

  if (correct) {
    sndCorrect();
    const points = S.attempts === 0 ? 10 : 5;
    S.streak++;
    S.score += points + Math.min(S.streak, 5);
    if (S.streak > S.bestStreak) S.bestStreak = S.streak;
    S.correct++;
    S.results.push({ word, correct: true, attempts: S.attempts + 1 });

    const profile = getActiveProfile();
    updateMastery(profile, word, true);

    if (S.mode === 3) { // Rush ‚Äî immediate next word
      sndRush();
      S.wordIdx++;
      if (S.wordIdx >= S.words.length) {
        // Refill pool
        S.words = [...S.words, ...pickWords(LEVELS[S.level].key, 20)];
      }
      prepareWord();
      return;
    }

    S.lastCorrect = true;
    S.lastWord = word;
    S.screen = 'feedback';
    render();
    setTimeout(() => nextWord(), 1100);
  } else {
    sndWrong();
    S.attempts++;
    S.streak = 0;

    if (S.mode === 3) { // Rush ‚Äî just shake, try again
      render();
      return;
    }

    if (S.attempts >= 2) {
      S.results.push({ word, correct: false, attempts: S.attempts });
      const profile = getActiveProfile();
      updateMastery(profile, word, false);
      S.lastCorrect = false;
      S.lastWord = word;
      S.screen = 'feedback';
      render();
      setTimeout(() => nextWord(), 1800);
    } else {
      render();
    }
  }
}

function nextWord() {
  S.wordIdx++;
  if (S.wordIdx >= S.words.length) {
    // Round done
    const profile = getActiveProfile();
    profile.stats.totalScore += S.score;
    if (S.bestStreak > profile.stats.bestStreak) profile.stats.bestStreak = S.bestStreak;
    // Count newly mastered words
    const allWords = Object.values(WORDS).flat();
    profile.stats.wordsLearned = allWords.filter(w => (profile.mastery[w]||{}).stars >= 5).length;
    saveActiveProfile(profile);
    if (S.correct === S.words.length) sndLevelUp();
    S.screen = 'results';
    render();
  } else {
    S.screen = 'game';
    prepareWord();
  }
}

// Discovery
function startDiscovery() {
  // Pick 3 words from each level
  S.discoveryWords = [];
  Object.keys(WORDS).forEach((key, lvlIdx) => {
    const picked = shuffle(WORDS[key]).slice(0, 3);
    picked.forEach(w => S.discoveryWords.push({ word: w, level: lvlIdx }));
  });
  S.discoveryWords = shuffle(S.discoveryWords);
  S.discoveryResults = [];
  S.discoveryIdx = 0;
  S.discoveryPhase = 'show';
  S.screen = 'discovery';
  showDiscoveryWord();
}

function showDiscoveryWord() {
  if (S.discoveryIdx >= S.discoveryWords.length) {
    render();
    return;
  }
  S.discoveryPhase = 'show';
  S.inputEnabled = false;
  render();
  const word = S.discoveryWords[S.discoveryIdx].word;
  const dur = Math.max(2500, Math.min(5000, word.length * 500));
  S.timer = setTimeout(() => {
    S.discoveryPhase = 'type';
    S.inputEnabled = true;
    render();
    $('input').focus();
  }, dur);
}

function checkDiscoveryAnswer(answer) {
  const entry = S.discoveryWords[S.discoveryIdx];
  const correct = answer.toLowerCase().trim() === entry.word.toLowerCase();
  S.discoveryResults.push({ word: entry.word, level: entry.level, correct });
  if (correct) sndCorrect(); else sndWrong();
  S.discoveryIdx++;
  if (S.discoveryIdx >= S.discoveryWords.length) {
    render(); // Show results
  } else {
    showDiscoveryWord();
  }
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  updateW();
  const scr = $('screen');
  const input = $('input');
  let content = '';
  let placeholder = 'Type here...';

  switch (S.screen) {
    case 'welcome':
      content = screenWelcome();
      placeholder = 'Press ENTER...';
      break;
    case 'profiles':
      content = screenProfiles();
      placeholder = 'Choose profile...';
      break;
    case 'newProfile':
      content = screenNewProfile();
      placeholder = S.newName ? 'Pick avatar (1-5) or type "go"...' : 'Your name...';
      break;
    case 'menu':
      content = screenMenu();
      placeholder = 'Choose option...';
      break;
    case 'levelSelect':
      content = screenLevelSelect();
      placeholder = 'Choose level (1-5)...';
      break;
    case 'modeSelect':
      content = screenModeSelect();
      placeholder = 'Choose mode (1-5)...';
      break;
    case 'game':
      content = screenGame();
      if (S.mode === 0 && S.phase === 'show') {
        placeholder = 'Watch the word...';
      } else if (S.mode === 3 && !S.rushActive) {
        placeholder = 'Choose option...';
      } else {
        placeholder = 'Type your answer...';
      }
      break;
    case 'feedback':
      content = screenFeedback();
      placeholder = '';
      break;
    case 'results':
      content = screenResults();
      placeholder = 'Choose option...';
      break;
    case 'progress':
      content = screenProgress();
      placeholder = 'Press 0 to go back...';
      break;
    case 'howToPlay':
      content = screenHowToPlay();
      placeholder = 'Press 0 to go back...';
      break;
    case 'discovery':
      content = screenDiscovery();
      if (S.discoveryIdx >= S.discoveryWords.length) {
        placeholder = 'Press ENTER...';
      } else {
        placeholder = S.discoveryPhase === 'show' ? 'Watch...' : 'Type the word...';
      }
      break;
    case 'deleteConfirm':
      content = screenDeleteConfirm();
      placeholder = 'Type yes or no...';
      break;
  }

  scr.innerHTML = content;
  scr.className = 'px-4 sm:px-6 pt-4 pb-2 text-t-fg text-[16px] sm:text-[18px] leading-[1.6] min-h-[40vh] sm:min-h-[60vh] whitespace-pre-wrap fade-in';
  input.placeholder = placeholder;
  input.disabled = !S.inputEnabled;
  if (S.inputEnabled) input.focus();

  // Update title bar and back button
  const profile = getActiveProfile();
  const titleBar = $('title-bar');
  const backBtn = $('back-btn');
  if (profile) {
    titleBar.textContent = `owlsh ‚Äî ${profile.name}`;
  } else {
    titleBar.textContent = 'owlsh v1.0';
  }
  const hasBack = S.screen !== 'welcome';
  if (backBtn) backBtn.className = hasBack ? 'text-t-dim text-xs px-1 visible' : 'text-t-dim text-xs px-1';
  const muteBtn = $('mute-btn');
  if (muteBtn) muteBtn.textContent = muted ? 'üîá' : 'üîä';

  // Scale logo to fit on small screens
  const logoEl = scr.querySelector('.logo-wrap');
  if (logoEl) {
    const contentPx = scr.clientWidth - parseFloat(getComputedStyle(scr).paddingLeft) - parseFloat(getComputedStyle(scr).paddingRight);
    const logoChars = 43; // LOGO width in characters
    const ruler = document.createElement('span');
    ruler.style.cssText = 'position:absolute;visibility:hidden;white-space:pre';
    ruler.textContent = '0'.repeat(logoChars);
    scr.appendChild(ruler);
    const logoPx = ruler.getBoundingClientRect().width;
    scr.removeChild(ruler);
    if (logoPx > contentPx) {
      const scale = contentPx / logoPx;
      logoEl.style.transform = `scale(${scale.toFixed(3)})`;
      logoEl.style.marginBottom = `-${(1 - scale) * logoEl.scrollHeight * 0.8}px`;
    } else {
      logoEl.style.transform = '';
      logoEl.style.marginBottom = '';
    }
  }
}

// ‚îÄ‚îÄ‚îÄ INPUT ROUTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleInput(value) {
  const v = value.trim();
  const vl = v.toLowerCase();

  switch (S.screen) {
    case 'welcome':
      initAudio();
      S.screen = 'profiles';
      break;

    case 'profiles': {
      const store = loadStore();
      if (v === '+' || (store.profiles.length === 0 && v === '1')) {
        S.newName = '';
        S.newAvatar = 0;
        S.screen = 'newProfile';
      } else {
        const idx = parseInt(v) - 1;
        if (idx >= 0 && idx < store.profiles.length) {
          setActiveProfileIndex(idx);
          S.screen = 'menu';
        }
      }
      break;
    }

    case 'newProfile':
      if (!S.newName) {
        if (v) {
          S.newName = v.slice(0, 20);
        }
      } else if (vl === 'go' || vl === 'done' || vl === 'create') {
        const av = AVATARS[S.newAvatar];
        createProfile(S.newName, av.id);
        S.screen = 'menu';
      } else {
        const n = parseInt(v) - 1;
        if (n >= 0 && n < AVATARS.length) S.newAvatar = n;
      }
      break;

    case 'menu':
      if (v === '1') {
        const profile = getActiveProfile();
        if (profile.level === null) {
          // Need discovery first
          startDiscovery();
          return;
        }
        S.level = profile.level;
        S.screen = 'levelSelect';
      } else if (v === '2') {
        startDiscovery();
        return;
      } else if (v === '3') {
        S.screen = 'progress';
      } else if (v === '4') {
        S.screen = 'howToPlay';
      } else if (vl === 'p') {
        S.screen = 'profiles';
      } else if (vl === 'x') {
        S.screen = 'deleteConfirm';
      }
      break;

    case 'deleteConfirm':
      if (vl === 'yes') {
        const store = loadStore();
        store.profiles.splice(store.activeProfile, 1);
        store.activeProfile = store.profiles.length > 0 ? 0 : null;
        saveStore(store);
        S.screen = store.profiles.length > 0 ? 'profiles' : 'profiles';
      } else {
        S.screen = 'menu';
      }
      break;

    case 'levelSelect':
      if (v === '0') { S.screen = 'menu'; break; }
      const lvl = parseInt(v) - 1;
      if (lvl >= 0 && lvl < LEVELS.length) {
        S.level = lvl;
        S.screen = 'modeSelect';
      }
      break;

    case 'modeSelect':
      if (v === '0') { S.screen = 'levelSelect'; break; }
      const mode = parseInt(v) - 1;
      if (mode >= 0 && mode < MODES.length) {
        S.mode = mode;
        startRound();
        return;
      }
      break;

    case 'game':
      if (S.mode === 0 && S.phase === 'show') return;
      if (S.mode === 3 && !S.rushActive) {
        // Rush ended ‚Äî menu options
        if (v === '1') { startRound(); return; }
        if (v === '2') { S.screen = 'modeSelect'; break; }
        if (v === '0') { S.screen = 'menu'; break; }
        return;
      }
      if (v) {
        checkAnswer(v);
        return;
      }
      break;

    case 'feedback':
      return; // auto-advancing

    case 'results':
      if (v === '1') { startRound(); return; }
      if (v === '2') { S.screen = 'modeSelect'; break; }
      if (v === '3') { S.screen = 'levelSelect'; break; }
      if (v === '0') { S.screen = 'menu'; break; }
      break;

    case 'progress':
    case 'howToPlay':
      if (v === '0' || v === '') S.screen = 'menu';
      break;

    case 'discovery':
      if (S.discoveryIdx >= S.discoveryWords.length) {
        // Results screen ‚Äî press enter to continue
        S.screen = 'menu';
        break;
      }
      if (S.discoveryPhase === 'show') return;
      if (v) {
        checkDiscoveryAnswer(v);
        return;
      }
      break;
  }

  render();
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const input = $('input');

function goBack() {
  input.value = '';
  if (S.timer) { clearTimeout(S.timer); S.timer = null; }
  if (S.rushTimer) { clearInterval(S.rushTimer); S.rushTimer = null; }
  S.inputEnabled = true;
  if (S.screen === 'game' || S.screen === 'feedback' || S.screen === 'results') {
    S.screen = 'modeSelect';
  } else if (S.screen === 'discovery') {
    S.screen = 'menu';
  } else if (S.screen === 'modeSelect') {
    S.screen = 'levelSelect';
  } else if (S.screen === 'levelSelect') {
    S.screen = 'menu';
  } else if (S.screen === 'progress' || S.screen === 'howToPlay' || S.screen === 'deleteConfirm') {
    S.screen = 'menu';
  } else if (S.screen === 'newProfile') {
    S.screen = 'profiles';
  } else if (S.screen === 'menu') {
    S.screen = 'profiles';
  } else if (S.screen === 'profiles') {
    S.screen = 'welcome';
  }
  render();
}

input.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    e.preventDefault();
    goBack();
    return;
  }
  if (e.key === 'Enter') {
    e.preventDefault();
    const val = input.value;
    input.value = '';
    handleInput(val);
  }
});

// Keep focus on input
document.addEventListener('click', (e) => {
  if (!input.disabled && e.target.id !== 'back-btn' && e.target.id !== 'mute-btn') input.focus();
});

// Scroll input into view when mobile keyboard opens
if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', () => {
    $('input-bar').scrollIntoView({ block: 'end', behavior: 'smooth' });
  });
}

// Cleanup timers on page unload
window.addEventListener('beforeunload', () => {
  if (S.timer) clearTimeout(S.timer);
  if (S.rushTimer) clearInterval(S.rushTimer);
});

// ‚îÄ‚îÄ‚îÄ SESSION RESTORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// On load, skip welcome screen if a profile already exists
function initScreen() {
  const store = loadStore();
  if (store.activeProfile !== null && store.profiles[store.activeProfile]) {
    initAudio();
    S.screen = 'menu';
  } else if (store.profiles.length > 0) {
    initAudio();
    S.screen = 'profiles';
  } else {
    S.screen = 'welcome';
  }
}

initScreen();
render();
window.addEventListener('resize', () => { updateW(); render(); });

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

</script>
</body>
</html>
